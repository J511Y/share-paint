name: PAI-16 CI Gate

on:
  workflow_dispatch:
    inputs:
      base_ref:
        description: "Base ref/SHA for diff (default: origin/develop)"
        required: false
        type: string
      head_ref:
        description: "Head ref/SHA for diff (default: current workflow SHA)"
        required: false
        type: string

permissions:
  contents: read

concurrency:
  group: pai16-ci-gate-manual-${{ github.ref }}
  # Hardening: do not auto-cancel in-flight gate checks; each run must complete explicitly.
  cancel-in-progress: false

jobs:
  non-doc-change-required:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Resolve diff refs
        id: refs
        shell: bash
        run: |
          set -euo pipefail
          BASE_REF="${{ github.event.inputs.base_ref }}"
          HEAD_REF="${{ github.event.inputs.head_ref }}"

          if [[ -z "$BASE_REF" ]]; then
            BASE_REF="origin/develop"
          fi

          if [[ -z "$HEAD_REF" ]]; then
            HEAD_REF="${GITHUB_SHA}"
          fi

          echo "base_ref=$BASE_REF" >> "$GITHUB_OUTPUT"
          echo "head_ref=$HEAD_REF" >> "$GITHUB_OUTPUT"
          echo "Using BASE_REF=$BASE_REF"
          echo "Using HEAD_REF=$HEAD_REF"

      - name: Fetch develop for comparison
        run: |
          git fetch --no-tags origin develop

      - name: Enforce manual-only non-doc change gate
        run: |
          ./.pi/checks/ci_gate_non_docs_change.sh \
            "${{ steps.refs.outputs.base_ref }}" \
            "${{ steps.refs.outputs.head_ref }}"
